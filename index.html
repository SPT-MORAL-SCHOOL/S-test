<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงเรียนสตรีพัทลุง | Satri Phatthalung School</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Imports (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State Management (State variables should be defined here)
        window.appState = {
            currentPage: 'home',
            isMenuOpen: false,
            isGroupDropdownOpen: false,
            isSubjectDropdownOpen: false,
            isDocumentDropdownOpen: false,
            isAdminLoggedIn: false,
            userId: null,
            db: null,
            auth: null,
            // Data stores for real-time updates
            groupsData: [],
            subjectsData: [],
            documentsData: { timetable: [], examSchedule: [], studentList: [] },
            admissionsData: { special: [], regular: [] },
            // Selected item for detail view
            selectedDetail: null,
            // Admin password (simplified for demo/single-file)
            ADMIN_PASSWORD: "sptadmin", 
            ADMIN_ID: "admin@spt.ac.th",
            // Helper constants
            APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'spt-default-app',
            FIREBASE_CONFIG: JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}')
        };
        
        // --- Core Firebase Initialization and Authentication ---
        const initFirebase = async () => {
            try {
                // Initialize Firebase App
                const app = initializeApp(window.appState.FIREBASE_CONFIG);
                window.appState.db = getFirestore(app);
                window.appState.auth = getAuth(app);
                
                // Set Firestore log level (optional, but useful for debugging)
                setLogLevel('error');

                // Sign in using the initial custom token or anonymously
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(window.appState.auth, token);
                } else {
                    await signInAnonymously(window.appState.auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(window.appState.auth, (user) => {
                    if (user) {
                        window.appState.userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", window.appState.userId);
                        // Start listening to data streams after successful auth
                        setupFirestoreListeners();
                    } else {
                        // User signed out or anonymous
                        window.appState.userId = 'anonymous';
                        console.log("Firebase Auth Ready. Anonymous User.");
                    }
                    renderApp(); // Re-render after auth state is known
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('app-content').innerHTML = `
                    <div class="p-8 text-center text-red-600">
                        <p class="text-xl font-bold">เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล:</p>
                        <p class="mt-2">โปรดตรวจสอบ Firebase Config หรือการเชื่อมต่ออินเทอร์เน็ต</p>
                    </div>
                `;
            }
        };

        // --- Firebase Firestore Data Listener Setup ---
        const setupFirestoreListeners = () => {
            if (!window.appState.db || !window.appState.userId) return;

            const db = window.appState.db;
            const appId = window.appState.APP_ID;

            // 1. Groups Data Listener
            const groupsCol = collection(db, `artifacts/${appId}/public/data/groups`);
            onSnapshot(groupsCol, (snapshot) => {
                window.appState.groupsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            }, (error) => console.error("Error fetching groups:", error));

            // 2. Subjects Data Listener
            const subjectsCol = collection(db, `artifacts/${appId}/public/data/subjects`);
            onSnapshot(subjectsCol, (snapshot) => {
                window.appState.subjectsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            }, (error) => console.error("Error fetching subjects:", error));

            // 3. Documents Data Listener (Simplified: one collection for all documents)
            const docsCol = collection(db, `artifacts/${appId}/public/data/documents`);
            onSnapshot(docsCol, (snapshot) => {
                const data = { timetable: [], examSchedule: [], studentList: [] };
                snapshot.docs.forEach(d => {
                    const docData = { id: d.id, ...d.data() };
                    if (docData.type === 'timetable') data.timetable.push(docData);
                    else if (docData.type === 'examSchedule') data.examSchedule.push(docData);
                    else if (docData.type === 'studentList') data.studentList.push(docData);
                });
                window.appState.documentsData = data;
                renderApp();
            }, (error) => console.error("Error fetching documents:", error));

            // 4. Admissions Data Listener (Special & Regular)
            const admissionsCol = collection(db, `artifacts/${appId}/public/data/admissions`);
            onSnapshot(admissionsCol, (snapshot) => {
                const data = { special: [], regular: [] };
                snapshot.docs.forEach(d => {
                    const docData = { id: d.id, ...d.data() };
                    if (docData.type === 'special') data.special.push(docData);
                    else if (docData.type === 'regular') data.regular.push(docData);
                });
                // Sort by date/timestamp if available, otherwise just use array order
                data.special.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
                data.regular.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
                window.appState.admissionsData = data;
                renderApp();
            }, (error) => console.error("Error fetching admissions:", error));
        };

        // --- CRUD Operations (Only available if isAdminLoggedIn is true) ---

        /**
         * Adds or updates a document in Firestore.
         * @param {string} collectionName - 'groups', 'subjects', 'documents', or 'admissions'.
         * @param {object} data - The data object to save.
         * @param {string} [docId=null] - Optional ID for updating an existing document.
         */
        const saveDocument = async (collectionName, data, docId = null) => {
            if (!window.appState.isAdminLoggedIn) {
                alertModal("สิทธิ์ไม่เพียงพอ", "คุณต้องเข้าสู่ระบบในฐานะผู้ดูแลระบบเพื่อดำเนินการนี้");
                return;
            }
            if (!window.appState.db) return;
            try {
                const db = window.appState.db;
                const path = `artifacts/${window.appState.APP_ID}/public/data/${collectionName}`;
                
                if (docId) {
                    // Update existing document
                    await setDoc(doc(db, path, docId), { ...data, timestamp: Date.now() }, { merge: true });
                    alertModal("สำเร็จ", `อัปเดตข้อมูล ${collectionName} เรียบร้อยแล้ว`);
                } else {
                    // Add new document
                    await addDoc(collection(db, path), { ...data, timestamp: Date.now() });
                    alertModal("สำเร็จ", `เพิ่มข้อมูล ${collectionName} เรียบร้อยแล้ว`);
                }
            } catch (e) {
                console.error("Error saving document: ", e);
                alertModal("ข้อผิดพลาด", `ไม่สามารถบันทึกข้อมูลได้: ${e.message}`);
            }
        };

        const deleteDocument = async (collectionName, docId) => {
            if (!window.appState.isAdminLoggedIn) {
                alertModal("สิทธิ์ไม่เพียงพอ", "คุณต้องเข้าสู่ระบบในฐานะผู้ดูแลระบบเพื่อดำเนินการนี้");
                return;
            }
            if (!window.appState.db) return;
            if (!confirm('ยืนยันการลบข้อมูลนี้หรือไม่?')) return;

            try {
                const db = window.appState.db;
                const docRef = doc(db, `artifacts/${window.appState.APP_ID}/public/data/${collectionName}`, docId);
                await deleteDoc(docRef);
                alertModal("สำเร็จ", "ลบข้อมูลเรียบร้อยแล้ว");
                // Navigate back to the main list after deletion
                navigate(collectionName);
            } catch (e) {
                console.error("Error deleting document: ", e);
                alertModal("ข้อผิดพลาด", `ไม่สามารถลบข้อมูลได้: ${e.message}`);
            }
        };

        // --- Admin Login/Logout Logic ---
        window.adminLogin = (password) => {
            if (password === window.appState.ADMIN_PASSWORD) {
                window.appState.isAdminLoggedIn = true;
                navigate('home');
                alertModal("เข้าสู่ระบบสำเร็จ", "คุณเข้าสู่ระบบในฐานะผู้ดูแลระบบแล้ว");
            } else {
                alertModal("เข้าสู่ระบบไม่สำเร็จ", "รหัสผ่านไม่ถูกต้อง");
            }
            renderApp();
        };

        window.adminLogout = () => {
            window.appState.isAdminLoggedIn = false;
            signOut(window.appState.auth);
            alertModal("ออกจากระบบสำเร็จ", "ออกจากระบบผู้ดูแลระบบแล้ว");
            navigate('home');
            renderApp();
        };
        
        // --- UI/State Helpers ---
        window.navigate = (page, detailId = null, subType = null) => {
            if (page === 'login') {
                // Keep the URL clean for the login path simulation
                window.history.pushState({}, '', '/login');
            } else {
                // Use hash routing for other pages
                const hash = detailId ? `#${page}-${detailId}` : `#${page}`;
                window.history.pushState({}, '', hash);
            }
            window.appState.currentPage = page;
            window.appState.selectedDetail = detailId;
            window.appState.selectedSubType = subType;
            window.appState.isMenuOpen = false; // Close mobile menu on navigation
            renderApp();
        };

        const getCurrentRoute = () => {
            if (window.location.pathname === '/login') return 'login';
            const hash = window.location.hash.substring(1);
            if (!hash) return 'home';

            // Check for detail routes (e.g., #groups-id123)
            const parts = hash.split('-');
            if (parts.length > 1 && (parts[0] === 'groups' || parts[0] === 'subjects')) {
                return parts[0];
            }
            
            // Handle specific document/admission pages (e.g., #documents)
            if (['documents', 'admissions'].includes(parts[0])) return parts[0];

            return hash;
        };

        // Modal (Replacement for alert/confirm)
        window.alertModal = (title, message) => {
            const modal = document.getElementById('alertModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
            }, 10);
        };

        window.closeModal = () => {
            const modal = document.getElementById('alertModal');
            modal.classList.remove('opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        // Initial setup and routing on load
        window.onload = () => {
            initFirebase();
            // Set initial page based on URL
            window.appState.currentPage = getCurrentRoute();
            renderApp();
        };

        // Handle browser back/forward buttons
        window.onhashchange = () => {
            window.appState.currentPage = getCurrentRoute();
            renderApp();
        };

        // Helper to toggle mobile menu
        window.toggleMenu = () => {
            window.appState.isMenuOpen = !window.appState.isMenuOpen;
            renderApp();
        };

        // Helper to toggle dropdowns
        window.toggleDropdown = (type) => {
            const stateKey = `is${type.charAt(0).toUpperCase() + type.slice(1)}DropdownOpen`;
            window.appState[stateKey] = !window.appState[stateKey];
            renderApp();
        };

        // --- Functions to Render Specific Pages ---

        const renderHomePage = () => `
            <!-- Hero Section -->
            <section class="min-h-[50vh] flex items-center justify-center bg-white p-6 md:p-12 shadow-inner">
                <div class="text-center max-w-4xl mx-auto">
                    <img src="https://img5.pic.in.th/file/secure-sv1/IMG_0310f4b22b3a3a8d0946.jpeg" 
                         onerror="this.onerror=null;this.src='https://placehold.co/200x200/1e40af/ffffff?text=SPT'"
                         alt="โลโก้โรงเรียนสตรีพัทลุง" class="w-48 h-48 mx-auto mb-4 rounded-full border-4 border-blue-500 shadow-xl object-cover">
                    <h1 class="text-5xl md:text-6xl font-extrabold text-blue-800 mb-2">
                        โรงเรียนสตรีพัทลุง
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-600 font-light italic">
                        Satrī Phatthalung School
                    </p>
                    <div class="mt-8">
                        <img src="https://placehold.co/1200x400/3B82F6/ffffff?text=ภาพโปสเตอร์+และกิจกรรมสำคัญของโรงเรียน"
                             alt="ภาพโปสเตอร์กิจกรรม" class="w-full rounded-xl shadow-2xl transition duration-500 ease-in-out transform hover:scale-[1.01]">
                    </div>
                </div>
            </section>
        `;

        const renderAboutPage = () => `
            <section class="min-h-[60vh] flex items-center justify-center p-8 bg-gray-50">
                <div class="text-center max-w-3xl p-10 bg-white rounded-xl shadow-2xl border-t-8 border-blue-500">
                    <h2 class="text-4xl font-bold text-blue-800 mb-4">เกี่ยวกับโรงเรียน</h2>
                    <p class="text-2xl text-red-500 font-semibold mt-6">
                        ขณะนี้อยู่ระหว่างดำเนินการปรับปรุงข้อมูล
                    </p>
                    <p class="text-gray-600 mt-4">
                        ขออภัยในความไม่สะดวก โรงเรียนกำลังจัดเตรียมข้อมูลและเนื้อหาที่สมบูรณ์ที่สุดเพื่อนำเสนอ
                    </p>
                </div>
            </section>
        `;

        // Function to generate the Admin CRUD form for Groups/Subjects
        const renderAdminForm = (collectionName, currentItem = null) => {
            const isGroup = collectionName === 'groups';
            const detailType = isGroup ? 'รองผู้อำนวยการกลุ่มงาน' : 'หัวหน้ากลุ่มสาระฯ';
            const initialTitle = currentItem?.title || '';
            const initialName = currentItem?.headName || '';
            const initialImageUrl = currentItem?.headImageUrl || 'https://placehold.co/150x150/93c5fd/1e40af?text=ภาพบุคลากร';
            const initialDocuments = JSON.stringify(currentItem?.documents || [], null, 2);

            return `
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-blue-500">
                    <h3 class="text-2xl font-bold text-blue-800 mb-6">${currentItem ? 'แก้ไข' : 'เพิ่ม'} ข้อมูล ${isGroup ? 'กลุ่มงาน' : 'กลุ่มสาระฯ'}</h3>
                    <form id="admin-form" onsubmit="event.preventDefault(); handleAdminSubmit('${collectionName}', '${currentItem?.id || ''}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ชื่อ${isGroup ? 'กลุ่มงาน' : 'กลุ่มสาระฯ'}</label>
                            <input type="text" id="form-title" value="${initialTitle}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ชื่อ ${detailType}</label>
                            <input type="text" id="form-headName" value="${initialName}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">URL ภาพ ${detailType} (150x150)</label>
                            <input type="url" id="form-headImageUrl" value="${initialImageUrl}" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">เอกสารที่เกี่ยวข้อง (JSON Array - [ {name: 'ชื่อเอกสาร', url: 'ลิ้งก์'}, ... ])</label>
                            <textarea id="form-documents" rows="5" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm font-mono text-sm">${initialDocuments}</textarea>
                        </div>
                        ${isGroup ? '' : `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ปุ่ม 'คณะครู' URL</label>
                                <input type="url" id="form-teacherUrl" value="${currentItem?.teacherUrl || ''}" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                            </div>
                        `}
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="navigate('${collectionName}')" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">ยกเลิก</button>
                            <button type="submit" class="py-2 px-4 border border-transparent rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition">
                                ${currentItem ? 'บันทึกการแก้ไข' : 'เพิ่มข้อมูล'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };

        // Function to handle the form submission (Groups/Subjects)
        window.handleAdminSubmit = async (collectionName, docId) => {
            const form = document.getElementById('admin-form');
            const title = form['form-title'].value;
            const headName = form['form-headName'].value;
            const headImageUrl = form['form-headImageUrl'].value;
            const teacherUrl = form['form-teacherUrl'] ? form['form-teacherUrl'].value : null;

            let documents;
            try {
                documents = JSON.parse(form['form-documents'].value);
                if (!Array.isArray(documents)) throw new Error("Documents must be a JSON array.");
            } catch (e) {
                alertModal("ข้อผิดพลาด", "รูปแบบเอกสาร JSON ไม่ถูกต้อง โปรดตรวจสอบอีกครั้ง");
                return;
            }

            const data = { title, headName, headImageUrl, documents };
            if (teacherUrl !== null) data.teacherUrl = teacherUrl;

            await saveDocument(collectionName, data, docId || null);
            navigate(collectionName);
        };

        // Renders the main view for a collection (Groups or Subjects)
        const renderCollectionView = (collectionName, data, title) => {
            const isGroup = collectionName === 'groups';
            const detailType = isGroup ? 'กลุ่มงาน' : 'กลุ่มสาระการเรียนรู้';
            const navItems = data.length > 0 ? data : [
                // Fallback structure if data is empty
                { id: '1', title: 'ตัวอย่างที่ 1', headName: 'รอข้อมูล', headImageUrl: 'https://placehold.co/150x150/93c5fd/1e40af?text=รอภาพ', documents: [] },
            ];

            return `
                <section class="min-h-[60vh] p-8 bg-gray-50">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-3xl font-bold text-blue-800 mb-6 border-b pb-2">${title}</h2>

                        ${window.appState.isAdminLoggedIn ? `
                            <div class="mb-6 flex justify-end">
                                <button onclick="navigate('${collectionName}', 'new')" class="py-2 px-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition">
                                    + เพิ่ม ${detailType}
                                </button>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${navItems.map(item => `
                                <div onclick="navigate('${collectionName}', '${item.id}')" 
                                     class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:-translate-y-1 cursor-pointer border-t-4 border-blue-500 text-center">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${item.title}</h3>
                                    <p class="text-sm text-gray-500">${item.headName || 'รอการกำหนดบุคลากร'}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
        };
        
        // Renders the detail view for a specific Group or Subject
        const renderDetailView = (collectionName, itemId) => {
            const data = collectionName === 'groups' ? window.appState.groupsData : window.appState.subjectsData;
            const item = data.find(i => i.id === itemId);

            if (item?.id === 'new' && window.appState.isAdminLoggedIn) {
                return renderAdminForm(collectionName);
            }
            if (!item) return render404();

            const isGroup = collectionName === 'groups';
            const detailType = isGroup ? 'รองผู้อำนวยการกลุ่มงาน' : 'หัวหน้ากลุ่มสาระฯ';

            return `
                <section class="p-8 bg-gray-50 min-h-[60vh]">
                    <div class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
                        <button onclick="navigate('${collectionName}')" class="text-blue-600 hover:text-blue-800 mb-4 font-medium flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            กลับสู่หน้าหลัก ${isGroup ? 'กลุ่มงาน' : 'กลุ่มสาระฯ'}
                        </button>
                        
                        <h2 class="text-4xl font-bold text-blue-800 border-b pb-4 mb-6">${item.title}</h2>
                        
                        ${window.appState.isAdminLoggedIn ? `
                            <div class="flex space-x-3 mb-6">
                                <button onclick="navigate('${collectionName}', 'edit-${itemId}')" class="py-2 px-4 bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600 transition">แก้ไขข้อมูล</button>
                                <button onclick="deleteDocument('${collectionName}', '${itemId}')" class="py-2 px-4 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition">ลบข้อมูล</button>
                            </div>
                        ` : ''}

                        <!-- Head Person Info -->
                        <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-8 p-6 bg-blue-50/50 rounded-xl mb-8 border border-blue-200">
                            <img src="${item.headImageUrl || 'https://placehold.co/150x150/93c5fd/1e40af?text=ภาพบุคลากร'}" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/150x150/93c5fd/1e40af?text=ภาพบุคลากร'"
                                 alt="${detailType} ${item.headName}" 
                                 class="w-32 h-32 rounded-full shadow-lg object-cover border-4 border-blue-300 flex-shrink-0">
                            <div>
                                <p class="text-lg font-semibold text-gray-700">${detailType}</p>
                                <h3 class="text-3xl font-bold text-blue-800">${item.headName || 'อยู่ระหว่างการกำหนด'}</h3>
                                ${!isGroup ? `
                                    <a href="${item.teacherUrl || '#'}" target="_blank" class="mt-4 inline-block py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md">
                                        คณะครูกลุ่มสาระฯ &rarr;
                                    </a>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Documents -->
                        <div class="mt-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-1">เอกสารที่เกี่ยวข้อง</h3>
                            ${item.documents && item.documents.length > 0 ? `
                                <ul class="space-y-3">
                                    ${item.documents.map(doc => `
                                        <li class="p-3 bg-gray-100 rounded-lg flex justify-between items-center hover:bg-gray-200 transition">
                                            <span class="text-gray-700">${doc.name}</span>
                                            <a href="${doc.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">
                                                ดาวน์โหลด &rarr;
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <p class="text-gray-500 italic">ไม่มีเอกสารที่เกี่ยวข้องในขณะนี้</p>
                            `}
                        </div>
                    </div>
                </section>
            `;
        };

        // Function to render the main view for Documents/Admissions
        const renderListMainView = (collectionName, title, items) => {
            const isAdmin = window.appState.isAdminLoggedIn;
            const itemMap = {
                'timetable': { title: 'ตารางเรียน/ตารางสอน', type: 'timetable' },
                'examSchedule': { title: 'ตารางสอบ', type: 'examSchedule' },
                'studentList': { title: 'รายชื่อนักเรียน', type: 'studentList' },
                'regular': { title: 'ห้องเรียนปกติ', type: 'regular' },
                'special': { title: 'ห้องเรียนพิเศษ', type: 'special' }
            };

            const renderAdminDocForm = (type, currentDoc = null) => `
                <form onsubmit="event.preventDefault(); handleDocSubmit('${collectionName}', '${type}', '${currentDoc?.id || ''}')" class="mt-4 p-4 bg-white rounded-lg shadow-inner space-y-3">
                    <h4 class="font-bold text-blue-700">${currentDoc ? 'แก้ไข' : 'เพิ่ม'} ${itemMap[type].title}</h4>
                    <input type="text" id="doc-name-${type}" value="${currentDoc?.name || ''}" placeholder="ชื่อเอกสาร (เช่น ปีการศึกษา 2568)" required class="w-full p-2 border rounded-lg">
                    <input type="url" id="doc-url-${type}" value="${currentDoc?.url || ''}" placeholder="URL/ลิงก์เอกสาร" required class="w-full p-2 border rounded-lg">
                    <div class="flex space-x-2">
                        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition">${currentDoc ? 'บันทึก' : 'เพิ่ม'}</button>
                        ${currentDoc ? `<button type="button" onclick="deleteDocument('${collectionName}', '${currentDoc.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition">ลบ</button>` : ''}
                    </div>
                </form>
            `;

            const renderDocList = (type, list) => `
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">${itemMap[type].title}</h3>
                    ${isAdmin ? `<button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-blue-600 hover:underline text-sm mb-2">+ เพิ่ม/แก้ไข</button>
                    <div class="hidden space-y-2">
                        ${renderAdminDocForm(type)}
                        ${list.map(doc => renderAdminDocForm(type, doc)).join('')}
                    </div>` : ''}
                    
                    <ul class="space-y-2 mt-4">
                        ${list.length > 0 ? list.map(doc => `
                            <li class="flex justify-between items-center p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                                <span class="text-gray-700">${doc.name}</span>
                                <a href="${doc.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">
                                    ${collectionName === 'admissions' && type.includes('ประกาศ') ? 'ดูประกาศ' : 'ดูเอกสาร'} &rarr;
                                </a>
                            </li>
                        `).join('') : `<p class="text-gray-500 italic">ยังไม่มีข้อมูล</p>`}
                    </ul>
                </div>
            `;
            
            return `
                <section class="min-h-[60vh] p-8 bg-gray-50">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-3xl font-bold text-blue-800 mb-6 border-b pb-2">${title}</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${collectionName === 'documents' ? `
                                ${renderDocList('timetable', items.timetable)}
                                ${renderDocList('examSchedule', items.examSchedule)}
                                ${renderDocList('studentList', items.studentList)}
                            ` : `
                                ${renderDocList('special', items.special.filter(i => i.section === 'announcement'))}
                                ${renderDocList('regular', items.regular.filter(i => i.section === 'announcement'))}
                                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 text-center flex flex-col justify-center">
                                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">ระบบรับสมัคร</h3>
                                    <p class="text-gray-600 mb-4">เข้าสู่ระบบรับสมัครออนไลน์</p>
                                    <a href="#" target="_blank" class="py-2 px-4 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">เข้าสู่ระบบรับสมัคร &rarr;</a>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">ประกาศผล (พิเศษ)</h3>
                                    ${isAdmin ? `<button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-blue-600 hover:underline text-sm mb-2">+ เพิ่ม/แก้ไข</button>
                                    <div class="hidden space-y-2">
                                        ${renderAdminDocForm('special', {section: 'result'})}
                                        ${items.special.filter(i => i.section === 'result').map(doc => renderAdminDocForm('special', doc)).join('')}
                                    </div>` : ''}
                                    <ul class="space-y-2 mt-4">
                                        ${items.special.filter(i => i.section === 'result').length > 0 ? items.special.filter(i => i.section === 'result').map(doc => `
                                            <li class="flex justify-between items-center p-2 bg-gray-100 rounded-lg">
                                                <span class="text-gray-700">${doc.name}</span>
                                                <a href="${doc.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">
                                                    ดูผล &rarr;
                                                </a>
                                            </li>
                                        `).join('') : `<p class="text-gray-500 italic">ยังไม่ประกาศผล</p>`}
                                    </ul>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">ประกาศผล (ปกติ)</h3>
                                    ${isAdmin ? `<button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-blue-600 hover:underline text-sm mb-2">+ เพิ่ม/แก้ไข</button>
                                    <div class="hidden space-y-2">
                                        ${renderAdminDocForm('regular', {section: 'result'})}
                                        ${items.regular.filter(i => i.section === 'result').map(doc => renderAdminDocForm('regular', doc)).join('')}
                                    </div>` : ''}
                                    <ul class="space-y-2 mt-4">
                                        ${items.regular.filter(i => i.section === 'result').length > 0 ? items.regular.filter(i => i.section === 'result').map(doc => `
                                            <li class="flex justify-between items-center p-2 bg-gray-100 rounded-lg">
                                                <span class="text-gray-700">${doc.name}</span>
                                                <a href="${doc.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">
                                                    ดูผล &rarr;
                                                </a>
                                            </li>
                                        `).join('') : `<p class="text-gray-500 italic">ยังไม่ประกาศผล</p>`}
                                    </ul>
                                </div>
                            `}
                        </div>
                    </div>
                </section>
            `;
        };

        // Function to handle document/admission form submission
        window.handleDocSubmit = async (collectionName, type, docId) => {
            const name = document.getElementById(`doc-name-${type}`).value;
            const url = document.getElementById(`doc-url-${type}`).value;

            if (!name || !url) {
                alertModal("ข้อผิดพลาด", "โปรดกรอกชื่อและ URL เอกสารให้ครบถ้วน");
                return;
            }

            const data = { name, url, type }; // type: timetable, examSchedule, studentList, special, regular
            
            // For admissions result/announcement
            if (collectionName === 'admissions' && !docId) {
                const section = type.includes('special') ? 'announcement' : 'announcement';
                data.section = type.includes('result') ? 'result' : 'announcement';
                // For admission, determine if it's announcement or result based on surrounding context
                // Simplification: we check if the button is within a 'result' context (requires complex DOM traversal, so we simplify)
                data.section = (type === 'special' || type === 'regular') ? 'announcement' : 'result';
                
                // A better simplification: If the user is adding a *new* admission, assume it's an announcement unless they are using a specific result form. 
                // Since the forms are dynamically rendered in sections, we must rely on `type` alone.
                if (type === 'special' && document.querySelector(`#doc-name-special`).closest('.bg-white')?.querySelector('h3')?.textContent.includes('ประกาศผล')) {
                    data.section = 'result';
                } else if (type === 'regular' && document.querySelector(`#doc-name-regular`).closest('.bg-white')?.querySelector('h3')?.textContent.includes('ประกาศผล')) {
                    data.section = 'result';
                } else {
                     data.section = 'announcement';
                }

                // If docId exists, we can assume the section from the existing document.
                if (docId) {
                     const existingDoc = window.appState.admissionsData[type].find(d => d.id === docId);
                     data.section = existingDoc.section;
                }
            }
            
            await saveDocument(collectionName, data, docId || null);
            renderApp();
        };

        const renderContactPage = () => {
            const info = {
                address: 'เลขที่ 250 ถนนราเมศวร์ ต.คูหาสวรรค์ อ.เมืองพัทลุง จ.พัทลุง 93000',
                email: 'info@spt.ac.th',
                phone: '074-613-261',
                social: [
                    { name: 'Facebook (หลัก)', url: 'https://www.facebook.com/spt.ac.th', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5-7.5-3.358-7.5-7.5c0-4.142 3.358-7.5 7.5-7.5zm.08 11.232v2.768h-4v-2.768h-1.55l-.64-1.258h2.19v-.812c0-.623.167-1.056 1.144-1.056h1.22v-2.06c-.212-.03-.935-.11-1.777-.11-2.07 0-3.488 1.255-3.488 3.57v1.468h-2.31v1.258h2.31v5.18h4.42v-5.18h2.955l.445-1.258h-3.37l-.007-.007z"/></svg>` },
                    { name: 'Facebook (ตากล้อง)', url: 'https://www.facebook.com/photoavspt/', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm2.5 13.5h-5A1.5 1.5 0 018 14.5v-5A1.5 1.5 0 019.5 8h5A1.5 1.5 0 0116 9.5v5a1.5 1.5 0 01-1.5 1.5zM12 9a3 3 0 100 6 3 3 0 000-6zm3-1.5h.01v.01H15v-.01z"/></svg>` },
                    { name: 'Instagram', url: 'https://www.instagram.com/sptschool_official?igsh=MWM0NWl2MmF1cXhvdw==', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M7.5 13.5c0 .543.437 1.002.99 1.002h7.02c.553 0 .99-.459.99-1.002v-3.004c0-.543-.437-1.002-.99-1.002h-7.02c-.553 0-.99.459-.99 1.002v3.004zm7.02-4.5c.27 0 .49.215.49.492s-.22.492-.49.492h.01c-.27 0-.49-.215-.49-.492s.22-.492.49-.492zm-2.002 0c.55 0 .998.448.998.998s-.448.998-.998.998-1.002-.448-1.002-.998.448-.998 1.002-.998zm-2.51 0c.55 0 .998.448.998.998s-.448.998-.998.998-1.002-.448-1.002-.998.448-.998 1.002-.998z"/></svg>` },
                    { name: 'TikTok', url: 'https://www.tiktok.com/@spt_school?_t=ZS-90tOrK4pFtH&_r=1', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M21 7.917v-1.99a.5.5 0 00-.7-.45l-4.58 2.04a.5.5 0 01-.63-.37L13.5 1.5a.5.5 0 00-.97-.13l-1.5 4.5a.5.5 0 01-.63.37l-4.58-2.04a.5.5 0 00-.7.45v1.99c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v2.5c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v2.5c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v2.5c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v1.99c0 .276-.224.5-.5.5h-2.5c-.276 0-.5-.224-.5-.5v-1.99c0-.276-.224-.5-.5-.5h-2.5c-.276 0-.5-.224-.5-.5v-2.5c0-.276-.224-.5-.5-.5h-2.5c-.276 0-.5-.224-.5-.5v-2.5c0-.276-.224-.5-.5-.5H8c-.276 0-.5-.224-.5-.5v-2.5c0-.276.224-.5.5-.5h2.5c.276 0 .5-.224.5-.5V8.417z"/></svg>` },
                ]
            };

            return `
                <section class="min-h-[60vh] p-8 bg-gray-50">
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl border-t-8 border-blue-500">
                        <h2 class="text-4xl font-bold text-blue-800 mb-8 text-center">ติดต่อโรงเรียน</h2>
                        
                        <!-- Contact Info -->
                        <div class="space-y-6 mb-10">
                            <!-- Address -->
                            <div class="flex items-start p-4 bg-blue-50 rounded-lg shadow-sm">
                                <svg class="w-8 h-8 text-blue-600 mr-4 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <div>
                                    <p class="font-bold text-gray-800">ที่อยู่</p>
                                    <p class="text-gray-600">${info.address}</p>
                                </div>
                            </div>
                            <!-- Phone -->
                            <div class="flex items-start p-4 bg-blue-50 rounded-lg shadow-sm">
                                <svg class="w-8 h-8 text-blue-600 mr-4 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-11a2 2 0 01-2-2v-5a2 2 0 012-2h3.28z"></path></svg>
                                <div>
                                    <p class="font-bold text-gray-800">โทรศัพท์</p>
                                    <p class="text-gray-600">${info.phone}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Social Media -->
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ช่องทางโซเชียลมีเดีย</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${info.social.map(s => `
                                <a href="${s.url}" target="_blank" class="flex items-center p-4 bg-gray-100 rounded-xl hover:bg-blue-100 transition shadow-sm hover:shadow-md">
                                    <div class="w-6 h-6 text-blue-600 mr-3">${s.icon}</div>
                                    <span class="font-medium text-gray-700">${s.name}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
        };

        const renderLoginPage = () => `
            <section class="min-h-[60vh] flex items-center justify-center p-8 bg-gray-50">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-2xl border-t-8 border-blue-600">
                    <h2 class="text-3xl font-bold text-center text-blue-800">เข้าสู่ระบบผู้ดูแล</h2>
                    <p class="text-center text-gray-500">สำหรับบุคลากรผู้ได้รับมอบหมายเท่านั้น</p>
                    <form onsubmit="event.preventDefault(); window.adminLogin(document.getElementById('admin-pass').value);" class="space-y-4">
                        <div>
                            <label for="admin-user" class="block text-sm font-medium text-gray-700">บัญชีผู้ใช้</label>
                            <input type="text" id="admin-user" value="${window.appState.ADMIN_ID}" disabled class="mt-1 block w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                        </div>
                        <div>
                            <label for="admin-pass" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                            <input type="password" id="admin-pass" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="รหัสผ่านผู้ดูแลระบบ">
                        </div>
                        <button type="submit" class="w-full py-3 px-4 rounded-lg shadow-md text-white bg-blue-600 hover:bg-blue-700 transition font-bold">
                            เข้าสู่ระบบ
                        </button>
                    </form>
                    <p class="text-center text-sm">
                        <a href="#" onclick="navigate('home')" class="text-blue-600 hover:underline">กลับหน้าหลัก</a>
                    </p>
                </div>
            </section>
        `;

        const render404 = () => `
            <section class="min-h-[60vh] flex items-center justify-center p-8 bg-gray-50">
                <div class="text-center p-10 bg-white rounded-xl shadow-2xl border-t-8 border-red-500">
                    <h2 class="text-6xl font-extrabold text-red-500 mb-4">404</h2>
                    <p class="text-2xl font-semibold text-gray-800">ไม่พบหน้านี้</p>
                    <p class="text-gray-600 mt-2">หน้าที่คุณกำลังมองหาอาจถูกย้ายหรือไม่มีอยู่</p>
                    <button onclick="navigate('home')" class="mt-6 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md">กลับหน้าหลัก</button>
                </div>
            </section>
        `;

        // --- Main Render Function ---
        window.renderApp = () => {
            const appContent = document.getElementById('app-content');
            const { currentPage, selectedDetail, isAdminLoggedIn, groupsData, subjectsData, documentsData, admissionsData } = window.appState;
            let contentHTML = '';

            // Handle Detail/Edit views for Groups/Subjects
            if (selectedDetail && (currentPage === 'groups' || currentPage === 'subjects')) {
                if (selectedDetail.startsWith('edit-') && isAdminLoggedIn) {
                    const itemId = selectedDetail.replace('edit-', '');
                    const currentItem = (currentPage === 'groups' ? groupsData : subjectsData).find(i => i.id === itemId);
                    contentHTML = renderAdminForm(currentPage, currentItem);
                } else {
                    const itemId = selectedDetail === 'new' ? selectedDetail : selectedDetail;
                    contentHTML = renderDetailView(currentPage, itemId);
                }
            } else {
                // Handle Main Page Views
                switch (currentPage) {
                    case 'home': contentHTML = renderHomePage(); break;
                    case 'about': contentHTML = renderAboutPage(); break;
                    case 'login': contentHTML = renderLoginPage(); break;
                    case 'groups': contentHTML = renderCollectionView('groups', groupsData, 'กลุ่มงานบริหาร'); break;
                    case 'subjects': contentHTML = renderCollectionView('subjects', subjectsData, 'กลุ่มสาระการเรียนรู้'); break;
                    case 'documents': contentHTML = renderListMainView('documents', 'ศูนย์รวมเอกสารสำคัญ', documentsData); break;
                    case 'admissions': contentHTML = renderListMainView('admissions', 'งานรับนักเรียน', admissionsData); break;
                    case 'contact': contentHTML = renderContactPage(); break;
                    default: contentHTML = renderHomePage(); // Fallback
                }
            }
            appContent.innerHTML = contentHTML;
            renderNavigation(); // Re-render navigation to update active state/dropdowns
        };

        // Renders the Navigation Bar (Sticky Header)
        const renderNavigation = () => {
            const { isMenuOpen, isGroupDropdownOpen, isSubjectDropdownOpen, isDocumentDropdownOpen, isAdminLoggedIn, currentPage } = window.appState;
            const navContainer = document.getElementById('main-header');
            
            const dropdownData = {
                groups: [
                    { title: 'กลุ่มงานกิจการนักเรียน', path: 'groups', id: 'student-affairs' },
                    { title: 'กลุ่มงานบริหารทั่วไป', path: 'groups', id: 'general-admin' },
                    { title: 'กลุ่มงานวิชาการ', path: 'groups', id: 'academic-affairs' },
                    { title: 'กลุ่มงานบริหารงบประมาณ', path: 'groups', id: 'budget-admin' },
                ],
                subjects: [
                    { title: 'กลุ่มสาระฯ ภาษาไทย', path: 'subjects', id: 'thai' },
                    { title: 'กลุ่มสาระฯ คณิตศาสตร์', path: 'subjects', id: 'math' },
                    { title: 'กลุ่มสาระฯ วิทยาศาสตร์และเทคโนโลยี', path: 'subjects', id: 'science-tech' },
                    { title: 'กลุ่มสาระฯ สังคมศึกษาฯ', path: 'subjects', id: 'social-studies' },
                    { title: 'กลุ่มสาระฯ สุขศึกษาและพลศึกษา', path: 'subjects', id: 'health-pe' },
                    { title: 'กลุ่มสาระฯ ภาษาต่างประเทศ', path: 'subjects', id: 'foreign-lang' },
                    { title: 'กลุ่มสาระฯ ศิลปะ', path: 'subjects', id: 'art' },
                    { title: 'กลุ่มสาระฯ การงานอาชีพ', path: 'subjects', id: 'career' },
                    { title: 'งานแนะแนว', path: 'subjects', id: 'guidance' }, // Treated as a subject group
                ],
                documents: [
                    { title: 'ตารางเรียน/ตารางสอน', path: 'documents', id: 'timetable' },
                    { title: 'รายชื่อนักเรียน', path: 'documents', id: 'studentList' },
                    { title: 'ตารางสอบ', path: 'documents', id: 'examSchedule' },
                ]
            };

            const linkClass = (page) => `text-gray-700 hover:text-blue-600 font-medium transition duration-300 ${currentPage === page ? 'text-blue-600 font-bold border-b-2 border-blue-600' : ''}`;
            const dropdownLinkClass = `block px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition`;

            navContainer.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-20">
                        <!-- Logo/School Name -->
                        <div class="flex-shrink-0 flex items-center">
                            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_0310f4b22b3a3a8d0946.jpeg" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/40x40/1e40af/ffffff?text=SPT'"
                                 alt="โลโก้ SPT" class="w-10 h-10 mr-3 rounded-full object-cover">
                            <a href="#" onclick="navigate('home')" class="text-xl font-bold text-blue-800 hidden sm:block">
                                โรงเรียนสตรีพัทลุง
                            </a>
                        </div>

                        <!-- Desktop Navigation Links -->
                        <nav class="hidden md:flex space-x-2 lg:space-x-4 items-center">
                            <a href="#home" onclick="navigate('home')" class="${linkClass('home')} py-5">หน้าหลัก</a>
                            <a href="#about" onclick="navigate('about')" class="${linkClass('about')} py-5">เกี่ยวกับโรงเรียน</a>
                            
                            <!-- Groups Dropdown -->
                            <div class="relative">
                                <button onclick="toggleDropdown('group')" class="flex items-center ${linkClass('groups')} py-5">
                                    กลุ่มงาน
                                    <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isGroupDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="group-dropdown" class="absolute right-0 mt-2 w-72 origin-top-right bg-white border border-gray-200 rounded-lg shadow-xl z-20 ${isGroupDropdownOpen ? 'block' : 'hidden'}">
                                    <div class="py-1">
                                        ${dropdownData.groups.map(item => `
                                            <a href="#${item.path}-${item.id}" onclick="navigate('${item.path}', '${item.id}')" class="${dropdownLinkClass}">
                                                ${item.title}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Subjects Dropdown -->
                            <div class="relative">
                                <button onclick="toggleDropdown('subject')" class="flex items-center ${linkClass('subjects')} py-5">
                                    กลุ่มสาระการเรียนรู้
                                    <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isSubjectDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="subject-dropdown" class="absolute right-0 mt-2 w-72 origin-top-right bg-white border border-gray-200 rounded-lg shadow-xl z-20 ${isSubjectDropdownOpen ? 'block' : 'hidden'}">
                                    <div class="py-1">
                                        ${dropdownData.subjects.map(item => `
                                            <a href="#${item.path}-${item.id}" onclick="navigate('${item.path}', '${item.id}')" class="${dropdownLinkClass}">
                                                ${item.title}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Documents Dropdown -->
                            <div class="relative">
                                <button onclick="toggleDropdown('document')" class="flex items-center ${linkClass('documents')} py-5">
                                    เอกสาร
                                    <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isDocumentDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="document-dropdown" class="absolute right-0 mt-2 w-64 origin-top-right bg-white border border-gray-200 rounded-lg shadow-xl z-20 ${isDocumentDropdownOpen ? 'block' : 'hidden'}">
                                    <div class="py-1">
                                        ${dropdownData.documents.map(item => `
                                            <a href="#${item.path}" onclick="navigate('${item.path}')" class="${dropdownLinkClass}">
                                                ${item.title}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <a href="#admissions" onclick="navigate('admissions')" class="${linkClass('admissions')} py-5">งานรับนักเรียน</a>
                            <a href="#contact" onclick="navigate('contact')" class="${linkClass('contact')} py-5">ติดต่อ</a>
                            
                            <!-- Login/Logout Button -->
                            ${isAdminLoggedIn ? `
                                <button onclick="adminLogout()" class="py-2 px-4 ml-2 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition duration-300 shadow-md">
                                    ออกจากระบบ (Admin)
                                </button>
                            ` : `
                                <a href="/login" onclick="navigate('login')" class="py-2 px-4 ml-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition duration-300 shadow-md">
                                    เข้าสู่ระบบ
                                </a>
                            `}
                        </nav>

                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMenu()" class="md:hidden text-gray-600 hover:text-blue-600 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isMenuOpen ? 'M6 18L18 6M6 6l12 12' : 'M4 6h16M4 12h16M4 18h16'}"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Menu (Conditional rendering) -->
                ${isMenuOpen ? `
                    <div id="mobile-menu" class="md:hidden bg-white shadow-inner pb-2 border-t border-gray-100">
                        <a href="#home" onclick="navigate('home')" class="block px-4 py-2 ${linkClass('home')}">หน้าหลัก</a>
                        <a href="#about" onclick="navigate('about')" class="block px-4 py-2 ${linkClass('about')}">เกี่ยวกับโรงเรียน</a>

                        <!-- Mobile Groups Dropdown -->
                        <div class="px-4">
                            <button onclick="toggleDropdown('group')" class="flex justify-between items-center w-full py-2 ${linkClass('groups')}">
                                กลุ่มงาน
                                <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isGroupDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="pl-4 border-l-2 border-gray-100 ${isGroupDropdownOpen ? 'block' : 'hidden'}">
                                ${dropdownData.groups.map(item => `<a href="#${item.path}-${item.id}" onclick="navigate('${item.path}', '${item.id}')" class="block py-2 text-sm text-gray-600 hover:bg-blue-50">${item.title}</a>`).join('')}
                            </div>
                        </div>

                        <!-- Mobile Subjects Dropdown -->
                        <div class="px-4">
                            <button onclick="toggleDropdown('subject')" class="flex justify-between items-center w-full py-2 ${linkClass('subjects')}">
                                กลุ่มสาระการเรียนรู้
                                <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isSubjectDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="pl-4 border-l-2 border-gray-100 ${isSubjectDropdownOpen ? 'block' : 'hidden'}">
                                ${dropdownData.subjects.map(item => `<a href="#${item.path}-${item.id}" onclick="navigate('${item.path}', '${item.id}')" class="block py-2 text-sm text-gray-600 hover:bg-blue-50">${item.title}</a>`).join('')}
                            </div>
                        </div>
                        
                        <!-- Mobile Documents Dropdown -->
                        <div class="px-4">
                            <button onclick="toggleDropdown('document')" class="flex justify-between items-center w-full py-2 ${linkClass('documents')}">
                                เอกสาร
                                <svg class="w-4 h-4 ml-1 transition-transform duration-200 ${isDocumentDropdownOpen ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="pl-4 border-l-2 border-gray-100 ${isDocumentDropdownOpen ? 'block' : 'hidden'}">
                                ${dropdownData.documents.map(item => `<a href="#${item.path}" onclick="navigate('${item.path}')" class="block py-2 text-sm text-gray-600 hover:bg-blue-50">${item.title}</a>`).join('')}
                            </div>
                        </div>

                        <a href="#admissions" onclick="navigate('admissions')" class="block px-4 py-2 ${linkClass('admissions')}">งานรับนักเรียน</a>
                        <a href="#contact" onclick="navigate('contact')" class="block px-4 py-2 ${linkClass('contact')}">ติดต่อ</a>
                        
                        <!-- Mobile Login/Logout -->
                        ${isAdminLoggedIn ? `
                            <button onclick="adminLogout()" class="block w-full text-center py-2 px-4 mx-4 mt-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300">
                                ออกจากระบบ (Admin)
                            </button>
                        ` : `
                            <a href="/login" onclick="navigate('login')" class="block w-full text-center py-2 px-4 mx-4 mt-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">
                                เข้าสู่ระบบ
                            </a>
                        `}
                    </div>
                ` : ''}
            `;
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Custom Tailwind Config for Kanit font and school colors -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;800&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .text-blue-800 { color: #1e40af; } /* Primary School Color */
        .bg-blue-600 { background-color: #2563eb; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .border-blue-600 { border-color: #2563eb; }
    </style>

    <!-- 1. Modal Alert (Replacement for window.alert/confirm) -->
    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-300">
            <h3 id="modalTitle" class="text-xl font-bold text-blue-800 mb-3"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">ตกลง</button>
        </div>
    </div>

    <!-- 2. Header and Sticky Navigation -->
    <header id="main-header" class="sticky top-0 z-50 bg-white shadow-xl">
        <!-- Content injected by renderNavigation() -->
    </header>

    <!-- 3. Main Content Container (SPA View) -->
    <main id="app-content" class="min-h-screen">
        <div class="flex justify-center items-center h-96">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-4 text-blue-800">กำลังโหลด...</p>
        </div>
        <!-- Content injected by renderApp() -->
    </main>

    <!-- 4. Footer -->
    <footer class="bg-gray-800 text-white py-10 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-8">
                <!-- Unit Links -->
                <div>
                    <h5 class="text-lg font-bold mb-3 border-b border-blue-400 pb-1 text-blue-300">หน่วยงานที่เกี่ยวข้อง</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="http://www.moe.go.th/" target="_blank" class="text-gray-300 hover:text-white transition">กระทรวงศึกษาธิการ</a></li>
                        <li><a href="https://www.obec.go.th/" target="_blank" class="text-gray-300 hover:text-white transition">สพฐ.</a></li>
                        <li><a href="https://secondary12.go.th/" target="_blank" class="text-gray-300 hover:text-white transition">สพม. พัทลุง</a></li>
                        <li><a href="https://phatthalung.moe.go.th/" target="_blank" class="text-gray-300 hover:text-white transition">ศึกษาธิการจังหวัดพัทลุง</a></li>
                    </ul>
                </div>
                <!-- System Links -->
                <div>
                    <h5 class="text-lg font-bold mb-3 border-b border-blue-400 pb-1 text-blue-300">ระบบงาน</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="http://2b.spt.ac.th" target="_blank" class="text-gray-300 hover:text-white transition">2b.spt.ac.th</a></li>
                        <li><a href="http://sgs.bopp-obec.info" target="_blank" class="text-gray-300 hover:text-white transition">sgs.bopp-obec.info</a></li>
                        <li><a href="http://apps.myschool.in.th/login" target="_blank" class="text-gray-300 hover:text-white transition">apps.myschool.in.th/login</a></li>
                        <li><a href="https://plg.mreschool.net/mainEschool/" target="_blank" class="text-gray-300 hover:text-white transition">e-School (plg.mreschool.net)</a></li>
                    </ul>
                </div>
                <!-- Contact Info in Footer -->
                <div class="col-span-2 md:col-span-2">
                    <h5 class="text-lg font-bold mb-3 border-b border-blue-400 pb-1 text-blue-300">ติดต่อโรงเรียน</h5>
                    <p class="text-sm text-gray-300 mb-2">โรงเรียนสตรีพัทลุง</p>
                    <p class="text-sm text-gray-300 mb-4">250 ถ.ราเมศวร์ ต.คูหาสวรรค์ อ.เมืองพัทลุง จ.พัทลุง 93000</p>
                    <div class="flex space-x-4">
                        <a href="https://www.facebook.com/spt.ac.th" target="_blank" class="text-gray-400 hover:text-blue-500 transition duration-300">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 2c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5-7.5-3.358-7.5-7.5c0-4.142 3.358-7.5 7.5-7.5zm.08 11.232v2.768h-4v-2.768h-1.55l-.64-1.258h2.19v-.812c0-.623.167-1.056 1.144-1.056h1.22v-2.06c-.212-.03-.935-.11-1.777-.11-2.07 0-3.488 1.255-3.488 3.57v1.468h-2.31v1.258h2.31v5.18h4.42v-5.18h2.955l.445-1.258h-3.37l-.007-.007z"/></svg>
                        </a>
                        <a href="https://www.instagram.com/sptschool_official" target="_blank" class="text-gray-400 hover:text-blue-500 transition duration-300">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M7.5 13.5c0 .543.437 1.002.99 1.002h7.02c.553 0 .99-.459.99-1.002v-3.004c0-.543-.437-1.002-.99-1.002h-7.02c-.553 0-.99.459-.99 1.002v3.004zm7.02-4.5c.27 0 .49.215.49.492s-.22.492-.49.492h.01c-.27 0-.49-.215-.49-.492s.22-.492.49-.492zm-2.002 0c.55 0 .998.448.998.998s-.448.998-.998.998-1.002-.448-1.002-.998.448-.998 1.002-.998zm-2.51 0c.55 0 .998.448.998.998s-.448.998-.998.998-1.002-.448-1.002-.998.448-.998 1.002-.998z"/></svg>
                        </a>
                        <!-- TIKTOK icon is complex, using a generic one for simplicity or an inline SVG is better. Here I'll use a simplified version -->
                        <a href="https://www.tiktok.com/@spt_school" target="_blank" class="text-gray-400 hover:text-blue-500 transition duration-300">
                           <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 7.917v-1.99a.5.5 0 00-.7-.45l-4.58 2.04a.5.5 0 01-.63-.37L13.5 1.5a.5.5 0 00-.97-.13l-1.5 4.5a.5.5 0 01-.63.37l-4.58-2.04a.5.5 0 00-.7.45v1.99c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v2.5c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v2.5c0 .276.224.5.5.5h2.5c.276 0 .5.224.5.5v1.99c0 .276-.224.5-.5.5h-2.5c-.276 0-.5-.224-.5-.5v-1.99c0-.276-.224-.5-.5-.5h-2.5c-.276 0-.5-.224-.5-.5v-2.5c0-.276-.224-.5-.5-.5h-2.5c-.276 0-.5-.224-.5-.5V8.417z"/></svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="text-center border-t border-gray-700 pt-6">
                <p class="text-sm text-gray-400">&copy; <span id="current-year"></span> โรงเรียนสตรีพัทลุง | Satri Phatthalung School</p>
            </div>
        </div>
    </footer>

    <!-- JS to set current year -->
    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>

